---
import LayoutDomaine from '../layouts/Layout-Domaine.astro';
import LayoutStudio from './Layout-Studio.astro';
import SectionBlogFeed from '../components/global/sections/section-BlogFeed.astro';
import BlogPostBody from '../components/global/blog/blog-PostBody.astro';
import BlogPostHero from '../components/global/blog/blog-PostHero.astro';
import BlogPostAuthors from '../components/global/blog/blog-PostAuthors.astro';
import BlogPostSidebar from '../components/global/blog/blog-Post-Sidebar.astro';
import GlobalSections from '../components/global/sections/section-GlobalSections.astro';
import { urlFor } from '../lib/cms-queries';
import { Translations } from '../lib/locales';
import { getCollection } from 'astro:content';
import { Brands } from '../enums/brands';
import { getLocaleString, getTranslationString } from '../lib/translations';
import { getEntry } from 'astro:content';

const { content, locale , brand} = Astro.props;

const blogPosts = brand === Brands.STUDIO ? await getCollection('blogPosts_Studio') : await getCollection('blogPosts_Domaine')
const relatedPosts = await Promise.all(content.relatedPosts?.map( async (post) => brand === Brands.STUDIO ? await getEntry('blogPosts_Studio', post.slug.current) : await getEntry('blogPosts_Domaine', post.slug.current)  ))

const BrandLayout = brand === Brands.STUDIO ? LayoutStudio : LayoutDomaine
---
<BrandLayout
    title={`${content.metafields?.title ? getTranslationString(content.metafields.title, locale) : getTranslationString(content.title, locale)} | ${getLocaleString("INSIGHTS")}`}
    description={content.metafields?.description ? getTranslationString(content.metafields.description, locale) : null}
    image={content.metafields?.image ? urlFor(content.metafields.image).url() : null}
    searchFilter={content.isHidden ? "" : "type:blog-post_domaine"}
    activePath="/insights"
    noIndex={content.isHidden}
    showPreloader={false}
    locale={locale}
>
    <BlogPostHero
        post={content}
        locale={locale}
    />
    
    <BlogPostBody content={content.body} locale={locale}>
        <BlogPostSidebar 
            latestPosts={blogPosts.filter((post) => post.data.slug.current != content.slug.current).slice(0, 3)}
            locale={locale}
        />
    </BlogPostBody>

    { content.authors && 
        <BlogPostAuthors 
            authors={content.authors}
            locale={locale}
        />
    }

    {content.globalSections && content.globalSections.sections.map((section, i) => (
        <GlobalSections brand="domaine" section={section} key={i} locale={locale} />
    ))}

    { relatedPosts.length > 1 && 
        <SectionBlogFeed 
            heading={locale ? Translations['RELATED-POSTS'].locales[locale] : Translations['RELATED-POSTS'].name}
            posts={relatedPosts}
            locale={locale}
        />
    }
</BrandLayout>