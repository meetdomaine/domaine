---
import { sanityClient } from 'sanity:client';
import LayoutDomaine from '../../../layouts/Layout-Domaine.astro';
import { paths } from '../../../components/global/utils/paths';
import { blogCardFields, imageFields, projectGridFields, urlFor } from '../../../components/global/utils/cms-queries';
import SectionBlogFeed from '../../../components/global/sections/section-BlogFeed.astro';
import SectionProjectsFeed from '../../../components/global/sections/section-ProjectsFeed.astro';
import AtomRichContent from '../../../components/global/atoms/atom-richContent.astro';
import BlogPostBody from '../../../components/global/blog/blog-PostBody.astro';
import BlogPostHero from '../../../components/global/blog/blog-PostHero.astro';
import BlogPostAuthors from '../../../components/global/blog/blog-PostAuthors.astro';

export async function getStaticPaths() {
    const posts = await sanityClient.fetch(`
    *[_type == "type_blog" && agencyBrand->name == "Domaine"]{ 
        ..., 
        authors[]->{name, role, bio, ${imageFields}, department->{title} },
        thumbnailImage{${imageFields}},
        category->{..., slug{...} }, 
        body[]{ 
            ...,
            _type == "inlineImage" => {${imageFields}},
            _type == "imageGallery" => { images[]{${imageFields}} },
        },
        agencyBrand->{slug},
        "relatedPosts": *[_type == "type_blog" && references(^.category->_id)]{${blogCardFields}} | order(orderRank asc),
        "relatedProjects": 
            *[_type == "type_project" 
                && references(^.features[]->_id)
                // || references(^.services[]->_id)
                || references(^.industries[]->_id)
            ]{${projectGridFields}} | order(orderRank asc)[0...4]
        }`)
    return posts.map((post) => {
        // console.log(post)
        return {
            params: { post: post.slug.current, category: post.category.slug.current },
            props: { content: post }
        }
    })
}

interface Props {
    content: any
}

const { content } = Astro.props;
// console.log(content.body)

// const blogPosts = await sanityClient.fetch(`*[_type == "type_blog" && agencyBrand->name == "Domaine" && category->_id == '${content._id}' ] | order( postDate desc)`)
---
<LayoutDomaine
    title={content.title}
    searchFilter="type:blog-post"
    activePath="/insights"
>
    <BlogPostHero
        post={content}
    />
    
    <BlogPostBody 
        content={content.body}
    />

    { content.authors && 
        <BlogPostAuthors 
            authors={content.authors}
        />
    }

    { content.relatedPosts && 
        <SectionBlogFeed 
            heading="Related Posts"
            posts={content.relatedPosts}
        />
    }

    { content.relatedProjects.length > 0 && 
        <SectionProjectsFeed
            heading="Related Projects"
            projects={content.relatedProjects}
        />
    }
</LayoutDomaine>