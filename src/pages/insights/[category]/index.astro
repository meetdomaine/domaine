---
// SERVER RENDERED AT LOAD TIME
import { blogCardFields, imageBaseFields, urlFor } from '../../../lib/cms-queries';
import LayoutBlogIndex from '../../../layouts/Layout_BlogIndex.astro';
import { Brands } from '../../../enums/brands';
import { sanityClient } from 'sanity:client';
import { Locales } from '../../../enums/locales';

const { category } = Astro.params

const categoryContent = await sanityClient.fetch(`
*[_type == "type_blogCategory" && slug.current == '${category}'][0]{
    title,
    heading,
    slug,
    "posts": *[_type == "type_blog" && agencyBrand->name == '${Brands.DOMAINE}' && isHidden != true && category->slug.current == '${category}' ]{ ${blogCardFields} }|order(postDate desc),
    metafields{ title, description, image{${imageBaseFields}} },
    redirectPath,
}`)

if (categoryContent?.redirectPath) return Astro.redirect(categoryContent.redirectPath)
if (!categoryContent || categoryContent.posts.length === 0) return Astro.redirect('/404')
---
<LayoutBlogIndex
    blogPosts={categoryContent.posts}
    title={categoryContent.metafields?.title ? categoryContent.metafields.title : categoryContent.title}
    description={categoryContent.metafields?.description ? categoryContent.metafields.description : null}
    image={categoryContent.metafields?.image ? urlFor(categoryContent.metafields.image).url() : null}
    heading={categoryContent.title}
    subheading={categoryContent.heading}
    slug={categoryContent.slug}
    brand={Brands.DOMAINE}
    locale={Locales.EN}
/>

